<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/panel}" lang="en">

<head>
    <title>Eventify - Dashboard</title>
</head>

<body>
    <section layout:fragment="content">
        <div class="mb-6">
            <h6 class="text-lg font-semibold">Selamat datang!, <span th:text="${user}"></span></h6>
            <p class="text-gray-600">Berikut adalah informasi terbaru tentang website anda.</p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- Total Users Card -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total User</p>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="totalUsers">0</p>
                    </div>
                    <div class="bg-blue-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Total Events Card -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Event</p>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="totalEvents">0</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Total E-Tickets Card -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total E-Ticket</p>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="totalETickets">0</p>
                    </div>
                    <div class="bg-purple-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Total Orders Card -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Order</p>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="totalOrders">0</p>
                    </div>
                    <div class="bg-yellow-100 rounded-full p-3">
                        <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Event Statistics Chart -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Top 5 Event (Berdasarkan Tiket Terjual)</h3>
                <canvas id="eventStatsChart"></canvas>
            </div>

            <!-- Monthly Order Statistics Chart -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Statistik Order (6 Bulan Terakhir)</h3>
                <canvas id="monthlyOrderChart"></canvas>
            </div>
        </div>
    </section>

    <script layout:fragment="script">
        let eventStatsChart, monthlyOrderChart;

        function loadDashboardData() {
            $.ajax({
                url: '/api/admin/dashboard/summary',
                method: 'GET',
                success: function (data) {
                    // Update summary cards
                    $('#totalUsers').text(data.totalUsers || 0);
                    $('#totalEvents').text(data.totalEvents || 0);
                    $('#totalETickets').text(data.totalETickets || 0);
                    $('#totalOrders').text(data.totalOrders || 0);

                    // Create Event Stats Chart
                    if (data.eventStats && data.eventStats.length > 0) {
                        const eventLabels = data.eventStats.map(stat => stat.eventName);
                        const eventData = data.eventStats.map(stat => stat.ticketCount);

                        const ctx1 = document.getElementById('eventStatsChart').getContext('2d');
                        if (eventStatsChart) {
                            eventStatsChart.destroy();
                        }
                        eventStatsChart = new Chart(ctx1, {
                            type: 'bar',
                            data: {
                                labels: eventLabels,
                                datasets: [{
                                    label: 'Tiket Terjual',
                                    data: eventData,
                                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    }

                    // Create Monthly Order Chart
                    if (data.monthlyOrderStats && data.monthlyOrderStats.length > 0) {
                        const monthLabels = data.monthlyOrderStats.map(stat => stat.month);
                        const orderData = data.monthlyOrderStats.map(stat => stat.orderCount);

                        const ctx2 = document.getElementById('monthlyOrderChart').getContext('2d');
                        if (monthlyOrderChart) {
                            monthlyOrderChart.destroy();
                        }
                        monthlyOrderChart = new Chart(ctx2, {
                            type: 'line',
                            data: {
                                labels: monthLabels,
                                datasets: [{
                                    label: 'Jumlah Order',
                                    data: orderData,
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    borderColor: 'rgba(16, 185, 129, 1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    }
                },
                error: function (xhr) {
                    console.error('Error loading dashboard data:', xhr);
                    Swal.fire('Error', 'Gagal memuat data dashboard', 'error');
                }
            });
        }

        $(document).ready(function () {
            loadDashboardData();
        });
    </script>
</body>

</html>